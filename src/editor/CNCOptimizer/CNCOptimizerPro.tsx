import React, { useEffect, useState, useRef, useCallback } from 'react';
import { CNCProvider, useCNCStore } from './store';
import { useLivePanelData } from './hooks/useLivePanelData';
import { useProjectStore } from '@/store/core/projectStore';
import { useNavigate } from 'react-router-dom';
import { ArrowLeft, ArrowRight, Zap } from 'lucide-react';
import { setThemeColor } from '@/theme';

// Components
import PanelsTable from './components/SidebarLeft/PanelsTable';
import StockTable from './components/SidebarLeft/StockTable';
import OptionsCard from './components/SidebarLeft/OptionsCard';
import ExportBar from './components/ExportBar';
import CuttingLayoutPreview2 from './components/CuttingLayoutPreview2';
import SheetThumbnail from './components/SheetThumbnail';

// Utils
import { optimizePanelsMultiple } from './utils/optimizer';
import { showToast } from '@/utils/cutlist/csv';
import type { Panel, StockSheet } from '../../types/cutlist';
import { OptimizedResult } from './types';

// Styles
import styles from './CNCOptimizerPro.module.css';

function PageInner(){
  const navigate = useNavigate();
  const { basicInfo } = useProjectStore();
  const { panels: livePanels } = useLivePanelData();
  
  const { 
    panels, setPanels, 
    stock, setStock, 
    settings,
    selectedPanelId, setSelectedPanelId,
    currentSheetIndex, setCurrentSheetIndex
  } = useCNCStore();
  
  const [optimizationResults, setOptimizationResults] = useState<OptimizedResult[]>([]);
  const [isOptimizing, setIsOptimizing] = useState(false);
  const optimizeTimeoutRef = useRef<NodeJS.Timeout | null>(null);
  const containerRef = useRef<HTMLDivElement>(null);
  
  // Î∑∞Ïñ¥ ÏÉÅÌÉú (ÎØ∏Î¶¨Î≥¥Í∏∞ÏôÄ ÎèôÍ∏∞Ìôî)
  const [viewerScale, setViewerScale] = useState(1);
  const [viewerRotation, setViewerRotation] = useState(0);
  const [viewerOffset, setViewerOffset] = useState({ x: 0, y: 0 });

  // Handle ESC key to clear selection
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        setSelectedPanelId(null);
      }
    };

    const handleClickOutside = (e: MouseEvent) => {
      // Clear selection when clicking outside of panels
      const target = e.target as HTMLElement;
      if (!target.closest('.panel-clickable')) {
        setSelectedPanelId(null);
      }
    };

    document.addEventListener('keydown', handleKeyDown);
    document.addEventListener('click', handleClickOutside);

    return () => {
      document.removeEventListener('keydown', handleKeyDown);
      document.removeEventListener('click', handleClickOutside);
    };
  }, [setSelectedPanelId]);

  // Initialize with live data
  useEffect(() => {
    // Convert live panels to CutList format
    if (livePanels.length > 0) {
      console.log('üîÑ Converting live panels to CutList format');
      console.log('Live panels count:', livePanels.length);
      console.log('Live panels:', livePanels);
      
      const cutlistPanels: Panel[] = livePanels.map(p => {
        // Ìå®ÎÑêÏùò Í∏¥ Î∞©Ìñ•ÏùÑ L(ÏÑ∏Î°ú) Î∞©Ìñ•ÏúºÎ°ú Î∞∞Ïπò
        // Í∏¥ Ï™ΩÏù¥ lengthÍ∞Ä ÎêòÎèÑÎ°ù ÏÑ§Ï†ï
        let width = p.width;
        let length = p.height;
        
        // Í∞ÄÎ°úÍ∞Ä Îçî Í∏∏Î©¥ ÌöåÏ†ÑÏãúÏºúÏÑú ÏÑ∏Î°úÍ∞Ä Îçî Í∏∏Í≤å ÎßåÎì§Í∏∞
        if (width > length) {
          width = p.height;
          length = p.width;
        }
        
        // Í≤∞Î∞©Ìñ•ÏùÄ Ìï≠ÏÉÅ ÏÑ∏Î°ú(V)Î°ú ÏÑ§Ï†ï - Í∏¥ Î∞©Ìñ•Ïù¥ Í≤∞Î∞©Ìñ•
        let grain = 'V'; // ÏÑ∏Î°ú Í≤∞Î∞©Ìñ• (Í∏¥ Î∞©Ìñ•)
        
        return {
          id: p.id,
          label: p.name || `Panel_${p.id}`,
          width: width,   // ÏßßÏùÄ Ï™Ω
          length: length, // Í∏¥ Ï™Ω
          thickness: p.thickness || 18,
          quantity: p.quantity || 1,
          material: p.material || 'PB',
          grain: grain,
          canRotate: false // Í≤∞Î∞©Ìñ•Ïù¥ ÏûàÏúºÎØÄÎ°ú ÌöåÏ†Ñ Î∂àÍ∞Ä
        };
      });
      
      console.log('Converted panels count:', cutlistPanels.length);
      console.log('Converted panels:', cutlistPanels);
      setPanels(cutlistPanels);
    } else if (panels.length === 0) {
      // ÌÖåÏä§Ìä∏Ïö© Ìå®ÎÑê Ï∂îÍ∞Ä (live panelsÍ∞Ä ÏóÜÏùÑ ÎïåÎßå)
      console.log('‚ö†Ô∏è No live panels found, adding test panels');
      const testPanels: Panel[] = [
        { id: '1', label: 'Panel_1', width: 600, length: 800, thickness: 18, quantity: 2, material: 'PB', grain: 'V' },
        { id: '2', label: 'Panel_2', width: 450, length: 600, thickness: 18, quantity: 3, material: 'PB', grain: 'V' },
        { id: '3', label: 'Panel_3', width: 300, length: 400, thickness: 18, quantity: 4, material: 'MDF', grain: 'V' },
        { id: '4', label: 'Panel_4', width: 800, length: 1000, thickness: 18, quantity: 1, material: 'MDF', grain: 'V' },
        { id: '5', label: 'Panel_5', width: 550, length: 750, thickness: 18, quantity: 2, material: 'PB', grain: 'V' },
      ];
      setPanels(testPanels);
    }

    // Initialize default stock if empty
    if (stock.length === 0) {
      const defaultStock: StockSheet[] = [
        // 18mm PB (ÌååÌã∞ÌÅ¥Î≥¥Îìú) - Í∞ÄÍµ¨ Î≥∏Ï≤¥Ïö©
        {
          label: 'PB_18T_2440x1220',
          width: 1220,
          length: 2440,
          thickness: 18,
          quantity: 999,
          material: 'PB'
        },
        // 15mm PB - ÏÑúÎûçÏö©
        {
          label: 'PB_15T_2440x1220',
          width: 1220,
          length: 2440,
          thickness: 15,
          quantity: 999,
          material: 'PB'
        },
        // 9mm MDF - Îí∑ÌåêÏö©
        {
          label: 'MDF_9T_2440x1220',
          width: 1220,
          length: 2440,
          thickness: 9,
          quantity: 999,
          material: 'MDF'
        },
        // 5mm MDF - ÏÑúÎûç Î∞îÎã•Ïö©
        {
          label: 'MDF_5T_2440x1220',
          width: 1220,
          length: 2440,
          thickness: 5,
          quantity: 999,
          material: 'MDF'
        }
      ];
      setStock(defaultStock);
    }

    // Set theme color
    const theme = getComputedStyle(document.documentElement)
      .getPropertyValue('--theme')
      .trim();
    if (theme) {
      setThemeColor(`hsl(${theme})`);
    }
  }, [livePanels]);

  // Auto-optimize when data changes with debouncing
  useEffect(() => {
    if (panels.length > 0 && stock.length > 0) {
      // Clear previous timeout
      if (optimizeTimeoutRef.current) {
        clearTimeout(optimizeTimeoutRef.current);
      }
      
      // Set new timeout for optimization (debounce 500ms)
      optimizeTimeoutRef.current = setTimeout(() => {
        handleOptimize();
      }, 500);
    }
    
    // Cleanup
    return () => {
      if (optimizeTimeoutRef.current) {
        clearTimeout(optimizeTimeoutRef.current);
      }
    };
  }, [panels, stock, settings]);


  const handleOptimize = async () => {
    if (panels.length === 0) {
      showToast('No panels to optimize', 'error');
      return;
    }

    if (stock.length === 0) {
      showToast('No stock sheets defined', 'error');
      return;
    }

    setIsOptimizing(true);
    
    // ÏÑ§Ï†ïÍ∞íÏùÑ Ï†ÑÏó≠ Î≥ÄÏàòÎ°ú Ï†ÄÏû• (Î∑∞Ïñ¥ÏóêÏÑú Ï†ëÍ∑º Í∞ÄÎä•ÌïòÎèÑÎ°ù)
    (window as any).cncSettings = settings;
    
    try {
      // Group panels by material AND thickness
      const panelGroups = new Map<string, Panel[]>();
      
      panels.forEach(panel => {
        // Apply grain and rotation settings
        let processedPanel = { ...panel };
        
        // Ìå®ÎÑê ÏπòÏàòÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (widthÏôÄ lengthÎ•º Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå)
        console.log(`Panel ${panel.label}: ${panel.width}x${panel.length} (grain: ${panel.grain}, thickness: ${panel.thickness}mm)`);
        
        // Í≤∞Î∞©Ìñ• Í≥†Î†§ ÏÑ§Ï†ïÏù¥ ÏºúÏ†∏ÏûàÍ≥† Í≤∞Î∞©Ìñ•Ïù¥ ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÏúºÎ©¥ ÌöåÏ†Ñ Î∂àÍ∞Ä
        // Í≤∞Î∞©Ìñ•Ïù¥ V(ÏÑ∏Î°ú) ÎòêÎäî H(Í∞ÄÎ°ú)Ïù¥Î©¥ ÌöåÏ†Ñ Î∂àÍ∞Ä
        if (settings.considerGrain && panel.grain && (panel.grain === 'V' || panel.grain === 'H')) {
          processedPanel.canRotate = false;
        } else if (!settings.considerGrain) {
          // Í≤∞Î∞©Ìñ• Í≥†Î†§ÌïòÏßÄ ÏïäÏúºÎ©¥ ÌöåÏ†Ñ Í∞ÄÎä•
          processedPanel.canRotate = true;
        } else {
          // Í∑∏ Ïô∏Ïùò Í≤ΩÏö∞ (grainÏù¥ NONEÏù¥Í±∞ÎÇò ÏóÜÎäî Í≤ΩÏö∞)
          processedPanel.canRotate = true;
        }
        
        // Ïû¨ÏßàÍ≥º ÎëêÍªòÎ•º Î™®Îëê Í≥†Î†§ÌïòÏó¨ Í∑∏Î£πÌôî
        const key = settings.considerMaterial 
          ? `${processedPanel.material || 'DEFAULT'}_${processedPanel.thickness || 18}` 
          : 'ALL';
        if (!panelGroups.has(key)) {
          panelGroups.set(key, []);
        }
        panelGroups.get(key)!.push(processedPanel);
      });

      const allResults: OptimizedResult[] = [];

      // Optimize each material and thickness group
      for (const [key, groupPanels] of panelGroups) {
        // Parse material and thickness from key
        const [material, thicknessStr] = key.split('_');
        const thickness = parseInt(thicknessStr) || 18;
        
        // Find matching stock by material AND thickness
        let matchingStock = stock.find(s => 
          s.material === material && s.thickness === thickness
        );
        
        // If no exact match, try to find stock with same thickness
        if (!matchingStock) {
          matchingStock = stock.find(s => s.thickness === thickness);
        }
        
        // Last resort: use first stock (but warn)
        if (!matchingStock && stock.length > 0) {
          console.warn(`No matching stock for ${material} ${thickness}mm, using default stock`);
          matchingStock = stock[0];
        }

        if (matchingStock) {
          // Convert to optimizer format
          const stockPanel = {
            id: matchingStock.label || 'stock',
            width: matchingStock.width,
            height: matchingStock.length,
            material: matchingStock.material || 'PB',
            color: 'MW',
            price: 50000,
            stock: matchingStock.quantity
          };

          const optimizerPanels = groupPanels.map(p => ({
            id: p.id,
            name: p.label,
            width: p.width,
            height: p.length,
            thickness: p.thickness,
            quantity: p.quantity,
            material: p.material || 'PB',
            color: 'MW',
            grain: p.grain === 'H' ? 'HORIZONTAL' : 
                   p.grain === 'V' ? 'VERTICAL' : 
                   'VERTICAL', // Í∏∞Î≥∏Í∞íÏùÄ VERTICAL (ÏÑ∏Î°ú)
            canRotate: p.canRotate
          }));

          // Ïó¨Î∞±ÏùÑ Í≥†Î†§Ìïú ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Í≥µÍ∞Ñ Í≥ÑÏÇ∞
          const adjustedStockPanel = {
            ...stockPanel,
            width: stockPanel.width - (settings.trimLeft || 10) - (settings.trimRight || 10),
            height: stockPanel.height - (settings.trimTop || 10) - (settings.trimBottom || 10)
          };
          
          // Run optimization with adjusted stock size
          const results = await optimizePanelsMultiple(
            optimizerPanels,
            adjustedStockPanel, // Ïó¨Î∞±ÏùÑ Ï†úÏô∏Ìïú ÌÅ¨Í∏∞ ÏÇ¨Ïö©
            settings.singleSheetOnly ? 1 : 999, // Ï†úÌïú ÏóÜÏùå
            settings.alignVerticalCuts !== false, // Use aligned packing by default
            settings.kerf || 5 // ÌÜ±ÎÇ† ÎëêÍªò Ï†ÑÎã¨
          );
          
          // Ìå®ÎÑê ÏúÑÏπòÎ•º Ïó¨Î∞±ÎßåÌÅº Ïò§ÌîÑÏÖã
          results.forEach(result => {
            result.panels.forEach(panel => {
              panel.x += (settings.trimLeft || 10);
              panel.y += (settings.trimBottom || 10);
            });
            // ÏõêÎ≥∏ ÌÅ¨Í∏∞ Ï†ïÎ≥¥ Î≥µÏõê
            result.stockPanel = stockPanel;
          });
          
          console.log(`Optimization for ${material}: ${results.length} sheets generated`);
          console.log(`Panels to optimize: ${optimizerPanels.length}`);
          allResults.push(...results);
        }
      }

      console.log('=== Optimization Complete ===');
      console.log('Total sheets generated:', allResults.length);
      console.log('All results:', allResults);
      
      // Í∞Å ÏãúÌä∏Ïùò Ìå®ÎÑê Ïàò Ï∂úÎ†•
      allResults.forEach((result, index) => {
        console.log(`Sheet ${index + 1}: ${result.panels.length} panels, efficiency: ${result.efficiency.toFixed(1)}%`);
      });
      
      setOptimizationResults(allResults);
      setCurrentSheetIndex(0);
      
      if (allResults.length > 0) {
        const totalPanels = allResults.reduce((sum, r) => sum + r.panels.length, 0);
        showToast(`Optimized ${totalPanels} panels across ${allResults.length} sheets`, 'success');
      }
    } catch (error) {
      console.error('Optimization error:', error);
      showToast('Optimization failed', 'error');
    } finally {
      setIsOptimizing(false);
    }
  };

  const projectName = basicInfo?.title || 'New Project';

  return (
    <div className={styles.container}>
      {/* Header */}
      <div className={styles.header}>
        <div className={styles.headerLeft}>
          <h1>CNC Optimizer Pro</h1>
          <span className={styles.projectName}>{projectName}</span>
        </div>
        
        <div className={styles.headerRight}>
          <div className={styles.exportGroup}>
            <ExportBar optimizationResults={optimizationResults} />
          </div>
          <button 
            className={styles.exitButton}
            onClick={() => navigate('/configurator')}
          >
            ÎÇòÍ∞ÄÍ∏∞
            <ArrowRight size={18} />
          </button>
        </div>
      </div>

      {/* Main Content */}
      <div className={styles.main}>
        {/* Left Sidebar */}
        <div className={styles.leftSidebar}>
          <PanelsTable />
          <StockTable />
          <OptionsCard onSettingsChange={handleOptimize} />
        </div>

        {/* Center - Preview */}
        <div className={styles.centerPanel}>
          {optimizationResults.length > 0 ? (
            <div className={styles.viewerContainer}>
              <div className={styles.mainViewer}>
                <CuttingLayoutPreview2
                  result={optimizationResults[currentSheetIndex]}
                  highlightedPanelId={selectedPanelId}
                  showLabels={settings.labelsOnPanels}
                  onPanelClick={(id) => setSelectedPanelId(id)}
                  allowRotation={!settings.considerGrain}
                  // Î∑∞Ïñ¥ ÏÉÅÌÉú ÎèôÍ∏∞Ìôî
                  scale={viewerScale}
                  rotation={viewerRotation}
                  offset={viewerOffset}
                  onScaleChange={setViewerScale}
                  onRotationChange={setViewerRotation}
                  onOffsetChange={setViewerOffset}
                  sheetInfo={{
                    currentIndex: currentSheetIndex,
                    totalSheets: optimizationResults.length,
                    onOptimize: handleOptimize,
                    isOptimizing: isOptimizing
                  }}
                />
              </div>
              
              <div className={styles.thumbnailBar}>
                <div className={styles.thumbnailScroll}>
                  {optimizationResults.map((result, index) => (
                    <SheetThumbnail
                      key={index}
                      result={result}
                      index={index}
                      isActive={index === currentSheetIndex}
                      onClick={() => setCurrentSheetIndex(index)}
                      // Î∑∞Ïñ¥ ÏÉÅÌÉú Ï†ÑÎã¨ (ÌôúÏÑ± ÏãúÌä∏Îßå)
                      viewerScale={index === currentSheetIndex ? viewerScale : 1}
                      viewerRotation={index === currentSheetIndex ? viewerRotation : 0}
                      viewerOffset={index === currentSheetIndex ? viewerOffset : { x: 0, y: 0 }}
                      highlightedPanelId={index === currentSheetIndex ? selectedPanelId : null}
                    />
                  ))}
                </div>
              </div>
            </div>
          ) : (
            <div className={styles.emptyPreview}>
              <Zap size={48} />
              <h3>ÏµúÏ†ÅÌôî Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§</h3>
              <p>Ìå®ÎÑêÍ≥º ÏõêÏûêÏû¨Î•º ÏÑ§Ï†ïÌïú ÌõÑ "ÏµúÏ†ÅÌôî" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏÑ∏Ïöî</p>
              <button 
                className={`${styles.optimizeButtonLarge} ${styles.primary}`}
                onClick={handleOptimize}
                disabled={isOptimizing}
              >
                <Zap size={20} />
                {isOptimizing ? 'ÏµúÏ†ÅÌôî Ï§ë...' : 'ÏµúÏ†ÅÌôî ÏãúÏûë'}
              </button>
            </div>
          )}
        </div>

        {/* Right Sidebar - Stats */}
        <div className={styles.rightSidebar}>
          <div className={styles.rightSidebarContent}>
            <div className={styles.statsCard}>
              <h3>Ï†ÑÏ≤¥ ÌÜµÍ≥Ñ</h3>
              <div className={styles.stats}>
                <div className={styles.statItem}>
                  <span>Ï¥ù ÏãúÌä∏ Ïàò</span>
                  <strong>{optimizationResults.length}</strong>
                </div>
                <div className={styles.statItem}>
                  <span>Ï¥ù Ìå®ÎÑê Ïàò</span>
                  <strong>{panels.reduce((sum, p) => sum + p.quantity, 0)}</strong>
                </div>
                <div className={styles.statItem}>
                  <span>ÌèâÍ∑† Ìö®Ïú®</span>
                  <strong>
                    {optimizationResults.length > 0
                      ? (optimizationResults.reduce((sum, r) => sum + r.efficiency, 0) / optimizationResults.length).toFixed(1)
                      : 0}%
                  </strong>
                </div>
                <div className={styles.statItem}>
                  <span>Ï¥ù ÌèêÍ∏∞Îüâ</span>
                  <strong>
                    {(optimizationResults.reduce((sum, r) => sum + r.wasteArea, 0) / 1000000).toFixed(2)} m¬≤
                  </strong>
                </div>
              </div>
            </div>

            {optimizationResults[currentSheetIndex] && (
              <div className={styles.statsCard}>
                <h3>ÏãúÌä∏ {currentSheetIndex + 1} ÌÜµÍ≥Ñ</h3>
                <div className={styles.stats}>
                  <div className={styles.statItem}>
                    <span>Ìå®ÎÑê Ïàò</span>
                    <strong>{optimizationResults[currentSheetIndex].panels.length}</strong>
                  </div>
                  <div className={styles.statItem}>
                    <span>Ìö®Ïú®</span>
                    <strong>{optimizationResults[currentSheetIndex].efficiency.toFixed(1)}%</strong>
                  </div>
                  <div className={styles.statItem}>
                    <span>ÏÇ¨Ïö© Î©¥Ï†Å</span>
                    <strong>{(optimizationResults[currentSheetIndex].usedArea / 1000000).toFixed(2)} m¬≤</strong>
                  </div>
                  <div className={styles.statItem}>
                    <span>ÌèêÍ∏∞ Î©¥Ï†Å</span>
                    <strong>{(optimizationResults[currentSheetIndex].wasteArea / 1000000).toFixed(2)} m¬≤</strong>
                  </div>
                </div>
              </div>
            )}

            {/* Sheet List - ÎèôÏ†Å ÎÜíÏù¥ Í≥ÑÏÇ∞ */}
            {optimizationResults.length > 0 && (
              <div className={`${styles.statsCard} ${styles.sheetListCard}`}>
                <h3>ÏãúÌä∏ Î™©Î°ù ({optimizationResults.length}Í∞ú)</h3>
                <div className={styles.sheetList}>
                  {optimizationResults.map((result, index) => {
                    // ÏãúÌä∏Ïùò ÏõêÏûêÏû¨ Ï†ïÎ≥¥ Ï∞æÍ∏∞
                    const stockInfo = stock.find(s => 
                      s.material === result.stockPanel.material &&
                      s.width === result.stockPanel.width &&
                      s.length === result.stockPanel.height
                    );
                    const thickness = stockInfo?.thickness || 18;
                    
                    return (
                      <div 
                        key={index}
                        className={`${styles.sheetItem} ${index === currentSheetIndex ? styles.active : ''}`}
                        onClick={() => setCurrentSheetIndex(index)}
                      >
                        <span className={styles.sheetNumber}>{index + 1}</span>
                        <span className={styles.sheetInfo}>
                          {result.stockPanel.id || `${result.stockPanel.material}_${result.stockPanel.width}x${result.stockPanel.height}`}
                          <small>{thickness}T</small>
                        </span>
                        <span className={styles.sheetPanels}>{result.panels.length}Í∞ú</span>
                        <span className={styles.sheetEfficiency}>{result.efficiency.toFixed(0)}%</span>
                      </div>
                    );
                  })}
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

export default function CNCOptimizerPro(){
  return (
    <CNCProvider>
      <PageInner />
    </CNCProvider>
  );
}