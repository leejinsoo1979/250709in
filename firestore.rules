rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isSuperAdmin() {
      return isSignedIn() &&
             request.auth.token.email != null &&
             request.auth.token.email.lower() == 'sbbc212@gmail.com';
    }
    function isAdmin() {
      return isSignedIn() && (
        isSuperAdmin() ||
        exists(/databases/$(database)/documents/admins/$(request.auth.uid))
      );
    }
    function isTeamMember(teamId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid));
    }

    // admins - 관리자 권한 정보 (슈퍼 관리자만 관리)
    match /admins/{adminId} {
      allow read: if isAdmin();
      allow write: if isSuperAdmin();
    }

    // organizations - 조직 정보 (관리자만 모든 조직 읽기 가능)
    match /organizations/{orgId} {
      allow read, list: if isAdmin();
      allow create: if isSignedIn();
      allow update, delete: if isAdmin();
    }

    // users - 다른 사람 프로필 읽기 허용 (프로필 이미지, 이름 표시용)
    match /users/{uid} {
      allow read: if isSignedIn();
      allow list: if isAdmin(); // 관리자는 전체 사용자 목록 조회 가능
      allow create: if isSignedIn() && uid == request.auth.uid; // 본인 문서 생성
      allow update: if (isSignedIn() && uid == request.auth.uid) || isAdmin(); // 본인 또는 관리자가 수정 가능
      allow delete: if isAdmin(); // 관리자만 삭제 가능
    }

    // userProfiles - 사용자 프로필 정보 (다른 사람 프로필 읽기 허용)
    match /userProfiles/{uid} {
      allow read: if isSignedIn();
      allow list: if isAdmin(); // 관리자는 전체 프로필 목록 조회 가능
      allow create: if isSignedIn() && uid == request.auth.uid;
      allow update: if (isSignedIn() && uid == request.auth.uid) || isAdmin(); // 본인 또는 관리자가 수정 가능
      allow delete: if isSignedIn() && uid == request.auth.uid;
    }

    // loginHistory - 로그인 기록
    match /loginHistory/{historyId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn(); // 본인 로그인 기록 목록 조회 가능
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // 로그인 기록은 수정/삭제 불가
    }

    // teamInvitations - 팀 초대
    match /teamInvitations/{invitationId} {
      // 초대받은 사람이 자신의 초대장을 볼 수 있음
      allow read: if isSignedIn() && resource.data.inviteeEmail == request.auth.token.email;
      // 팀 멤버가 초대장을 생성할 수 있음
      allow create: if isSignedIn();
      // 초대받은 사람이 초대장을 업데이트(수락/거절)할 수 있음
      allow update: if isSignedIn() && resource.data.inviteeEmail == request.auth.token.email;
      allow delete: if isSignedIn() && resource.data.inviterId == request.auth.uid;
    }

    // sharedProjects - 공유된 프로젝트
    match /sharedProjects/{sharedId} {
      // 공유받은 사람이 자신의 공유 프로젝트를 볼 수 있음
      allow read: if isSignedIn() && resource.data.sharedWithUserId == request.auth.uid;
      // 프로젝트 소유자가 공유를 생성할 수 있음
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // 소유자나 공유받은 사람이 업데이트할 수 있음
      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.sharedWithUserId == request.auth.uid
      );
      // 소유자만 삭제할 수 있음
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    // teams + subcollections
    match /teams/{teamId} {
      // 팀 문서 - 로그인한 사용자는 모든 팀을 읽을 수 있음 (클라이언트에서 필터링)
      allow read: if isSignedIn();
      allow list: if isAdmin(); // 관리자는 전체 팀 목록 조회 가능
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // 멤버
      match /members/{memberUid} {
        allow read: if isTeamMember(teamId);
        allow create: if isSignedIn() && memberUid == request.auth.uid; // 자기 자신 참여
        allow update, delete: if isTeamMember(teamId) && request.auth.uid == memberUid;
      }

      // 프로젝트/디자인
      match /projects/{projectId} {
        allow read, write: if isTeamMember(teamId);
        
        // ✅ NEW: Nested designs under projects
        match /designs/{designId} {
          allow read, write: if isTeamMember(teamId);

          // Nested versions under project designs
          match /versions/{versionId} {
            allow read: if isTeamMember(teamId);
            allow create: if isTeamMember(teamId);
            allow update, delete: if false; // immutable
          }
        }
      }
      
      // Team-level designs (for backward compatibility)
      match /designs/{designId} {
        allow read, write: if isTeamMember(teamId);

        // 버전: 불변
        match /versions/{versionId} {
          allow read: if isTeamMember(teamId);
          allow create: if isTeamMember(teamId);
          allow update, delete: if false; // immutable
        }
      }

      // 에셋/잡
      match /assets/{assetId} {
        allow read, write: if isTeamMember(teamId);
      }
      match /jobs/{jobId} {
        allow read, write: if isTeamMember(teamId);
      }
    }

    // Legacy(dualWrite 중만 허용)
    match /projects/{id} {
      // 읽기는 누구나 가능 (공유 링크 지원), 쓰기는 소유자 또는 편집 권한이 있는 사람만
      allow read: if true;
      allow list: if isAdmin(); // 관리자는 전체 프로젝트 목록 조회 가능
      allow write: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (exists(/databases/$(database)/documents/sharedProjectAccess/$(id + '_' + request.auth.uid)) &&
         get(/databases/$(database)/documents/sharedProjectAccess/$(id + '_' + request.auth.uid)).data.permission == 'editor')
      );
      allow create: if isSignedIn();

      // 관리자는 프로젝트 하위의 디자인 파일을 조회할 수 있음
      match /designs/{designId} {
        allow read: if isAdmin() || true; // 관리자 또는 공유 링크 지원
        allow list: if isAdmin();
        allow write: if isSignedIn();
      }
    }
    match /designFiles/{id} {
      // 공유 링크를 위해 읽기는 모두 허용
      allow read: if true;
      allow list: if isAdmin(); // 관리자는 전체 디자인 파일 목록 조회 가능

      // 생성: 본인이 소유자인 경우만
      allow create: if isSignedIn() && request.auth.uid == request.resource.data.userId;

      // 수정 및 삭제: 소유자이거나 편집 권한이 있는 경우
      allow update, delete: if isSignedIn() && (
        // 소유자인 경우 (삭제 시에는 resource.data 사용)
        request.auth.uid == resource.data.userId ||
        // 또는 해당 프로젝트에 대한 editor 권한이 있는 경우
        (exists(/databases/$(database)/documents/sharedProjectAccess/$(resource.data.projectId + '_' + request.auth.uid)) &&
         get(/databases/$(database)/documents/sharedProjectAccess/$(resource.data.projectId + '_' + request.auth.uid)).data.permission == 'editor')
      );
    }

    // 공유 링크
    match /shareLinks/{linkId} {
      allow create: if isSignedIn();
      allow read: if true; // 누구나 토큰으로 조회 가능
      allow list: if isAdmin(); // 관리자는 전체 공유 링크 목록 조회 가능
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    // 공유 프로젝트 접근 권한
    match /sharedProjectAccess/{accessId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow list: if isAdmin(); // 관리자는 전체 접근 권한 목록 조회 가능
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // 알림
    match /notifications/{notificationId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn(); // 본인 알림 목록 조회 가능
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // 변경 이력
    match /projectHistory/{historyId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
    }

    // 공유 링크 접근 로그
    match /shareLinkAccessLog/{logId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow list: if isAdmin(); // 관리자는 전체 접근 로그 조회 가능
    }

    // 활동 로그
    match /activityLogs/{logId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn(); // 본인 활동 로그 목록 조회 가능
    }

    // 폴더 데이터
    match /folderData/{projectId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && (
        get(/databases/$(database)/documents/projects/$(projectId)).data.userId == request.auth.uid ||
        (exists(/databases/$(database)/documents/sharedProjectAccess/$(projectId + '_' + request.auth.uid)) &&
         get(/databases/$(database)/documents/sharedProjectAccess/$(projectId + '_' + request.auth.uid)).data.permission == 'editor')
      );
      allow create: if isSignedIn();
    }

    // 메시지 - 관리자만 접근 가능
    match /messages/{messageId} {
      allow read, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // 팝업 - 관리자만 접근 가능
    match /popups/{popupId} {
      allow read, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // 챗봇 Q&A - 관리자만 쓰기, 모든 사용자는 읽기 가능
    match /chatbotQAs/{qaId} {
      allow read, list: if isSignedIn();
      allow create: if isAdmin();
      allow update, delete: if isAdmin();
    }

    // 챗봇 설정 - 관리자만 쓰기, 모든 사용자는 읽기 가능
    match /chatbotSettings/{settingId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // 시스템 설정 - 관리자만 접근 가능
    match /systemSettings/{settingId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    // API 키 - 본인 키만 읽기/쓰기 가능
    match /apiKeys/{keyId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if false; // API 키는 수정 불가
    }

    // 구독 정보 - 관리자만 접근 가능
    match /subscriptions/{subscriptionId} {
      allow read, list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}