rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isTeamMember(teamId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid));
    }

    // users
    match /users/{uid} {
      allow read, create, update: if isSignedIn() && uid == request.auth.uid;
    }

    // userProfiles - 사용자 프로필 정보
    match /userProfiles/{uid} {
      allow read: if isSignedIn() && uid == request.auth.uid;
      allow create, update: if isSignedIn() && uid == request.auth.uid;
      allow delete: if isSignedIn() && uid == request.auth.uid;
    }

    // loginHistory - 로그인 기록
    match /loginHistory/{historyId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // 로그인 기록은 수정/삭제 불가
    }

    // teamInvitations - 팀 초대
    match /teamInvitations/{invitationId} {
      // 초대받은 사람이 자신의 초대장을 볼 수 있음
      allow read: if isSignedIn() && resource.data.inviteeEmail == request.auth.token.email;
      // 팀 멤버가 초대장을 생성할 수 있음
      allow create: if isSignedIn();
      // 초대받은 사람이 초대장을 업데이트(수락/거절)할 수 있음
      allow update: if isSignedIn() && resource.data.inviteeEmail == request.auth.token.email;
      allow delete: if isSignedIn() && resource.data.inviterId == request.auth.uid;
    }

    // sharedProjects - 공유된 프로젝트
    match /sharedProjects/{sharedId} {
      // 공유받은 사람이 자신의 공유 프로젝트를 볼 수 있음
      allow read: if isSignedIn() && resource.data.sharedWithUserId == request.auth.uid;
      // 프로젝트 소유자가 공유를 생성할 수 있음
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // 소유자나 공유받은 사람이 업데이트할 수 있음
      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.sharedWithUserId == request.auth.uid
      );
      // 소유자만 삭제할 수 있음
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    // teams + subcollections
    match /teams/{teamId} {
      // 팀 문서
      allow read: if isTeamMember(teamId);
      allow create: if isSignedIn() && teamId == request.auth.uid; // 개인 팀 최초 생성
      allow update, delete: if isTeamMember(teamId);

      // 멤버
      match /members/{memberUid} {
        allow read: if isTeamMember(teamId);
        allow create: if isSignedIn() && memberUid == request.auth.uid; // 자기 자신 참여
        allow update, delete: if isTeamMember(teamId) && request.auth.uid == memberUid;
      }

      // 프로젝트/디자인
      match /projects/{projectId} {
        allow read, write: if isTeamMember(teamId);
        
        // ✅ NEW: Nested designs under projects
        match /designs/{designId} {
          allow read, write: if isTeamMember(teamId);

          // Nested versions under project designs
          match /versions/{versionId} {
            allow read: if isTeamMember(teamId);
            allow create: if isTeamMember(teamId);
            allow update, delete: if false; // immutable
          }
        }
      }
      
      // Team-level designs (for backward compatibility)
      match /designs/{designId} {
        allow read, write: if isTeamMember(teamId);

        // 버전: 불변
        match /versions/{versionId} {
          allow read: if isTeamMember(teamId);
          allow create: if isTeamMember(teamId);
          allow update, delete: if false; // immutable
        }
      }

      // 에셋/잡
      match /assets/{assetId} {
        allow read, write: if isTeamMember(teamId);
      }
      match /jobs/{jobId} {
        allow read, write: if isTeamMember(teamId);
      }
    }

    // Legacy(dualWrite 중만 허용)
    match /projects/{id} {
      // 공유 링크를 위해 읽기는 모두 허용, 쓰기는 소유자만
      allow read: if true;
      allow write: if isSignedIn() &&
        (request.auth.uid == (request.resource.data.userId ?? resource.data.userId));
    }
    match /designFiles/{id} {
      // 공유 링크를 위해 읽기는 모두 허용, 쓰기는 소유자만
      allow read: if true;
      allow write: if isSignedIn() &&
        (request.auth.uid == (request.resource.data.userId ?? resource.data.userId));
    }
  }
}