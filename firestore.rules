rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() { return request.auth != null; }
    function isTeamMember(teamId) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/teams/$(teamId)/members/$(request.auth.uid));
    }

    // users
    match /users/{uid} {
      allow read, create, update: if isSignedIn() && uid == request.auth.uid;
    }

    // userProfiles - 사용자 프로필 정보
    match /userProfiles/{uid} {
      allow read: if isSignedIn() && uid == request.auth.uid;
      allow create, update: if isSignedIn() && uid == request.auth.uid;
      allow delete: if isSignedIn() && uid == request.auth.uid;
    }

    // loginHistory - 로그인 기록
    match /loginHistory/{historyId} {
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false; // 로그인 기록은 수정/삭제 불가
    }

    // teamInvitations - 팀 초대
    match /teamInvitations/{invitationId} {
      // 초대받은 사람이 자신의 초대장을 볼 수 있음
      allow read: if isSignedIn() && resource.data.inviteeEmail == request.auth.token.email;
      // 팀 멤버가 초대장을 생성할 수 있음
      allow create: if isSignedIn();
      // 초대받은 사람이 초대장을 업데이트(수락/거절)할 수 있음
      allow update: if isSignedIn() && resource.data.inviteeEmail == request.auth.token.email;
      allow delete: if isSignedIn() && resource.data.inviterId == request.auth.uid;
    }

    // sharedProjects - 공유된 프로젝트
    match /sharedProjects/{sharedId} {
      // 공유받은 사람이 자신의 공유 프로젝트를 볼 수 있음
      allow read: if isSignedIn() && resource.data.sharedWithUserId == request.auth.uid;
      // 프로젝트 소유자가 공유를 생성할 수 있음
      allow create: if isSignedIn() && request.resource.data.ownerId == request.auth.uid;
      // 소유자나 공유받은 사람이 업데이트할 수 있음
      allow update: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        resource.data.sharedWithUserId == request.auth.uid
      );
      // 소유자만 삭제할 수 있음
      allow delete: if isSignedIn() && resource.data.ownerId == request.auth.uid;
    }

    // teams + subcollections
    match /teams/{teamId} {
      // 팀 문서 - 로그인한 사용자는 모든 팀을 읽을 수 있음 (클라이언트에서 필터링)
      allow read: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();

      // 멤버
      match /members/{memberUid} {
        allow read: if isTeamMember(teamId);
        allow create: if isSignedIn() && memberUid == request.auth.uid; // 자기 자신 참여
        allow update, delete: if isTeamMember(teamId) && request.auth.uid == memberUid;
      }

      // 프로젝트/디자인
      match /projects/{projectId} {
        allow read, write: if isTeamMember(teamId);
        
        // ✅ NEW: Nested designs under projects
        match /designs/{designId} {
          allow read, write: if isTeamMember(teamId);

          // Nested versions under project designs
          match /versions/{versionId} {
            allow read: if isTeamMember(teamId);
            allow create: if isTeamMember(teamId);
            allow update, delete: if false; // immutable
          }
        }
      }
      
      // Team-level designs (for backward compatibility)
      match /designs/{designId} {
        allow read, write: if isTeamMember(teamId);

        // 버전: 불변
        match /versions/{versionId} {
          allow read: if isTeamMember(teamId);
          allow create: if isTeamMember(teamId);
          allow update, delete: if false; // immutable
        }
      }

      // 에셋/잡
      match /assets/{assetId} {
        allow read, write: if isTeamMember(teamId);
      }
      match /jobs/{jobId} {
        allow read, write: if isTeamMember(teamId);
      }
    }

    // Legacy(dualWrite 중만 허용)
    match /projects/{id} {
      // 읽기는 누구나 가능 (공유 링크 지원), 쓰기는 소유자 또는 편집 권한이 있는 사람만
      allow read: if true;
      allow write: if isSignedIn() && (
        resource.data.userId == request.auth.uid ||
        (exists(/databases/$(database)/documents/sharedProjectAccess/$(id + '_' + request.auth.uid)) &&
         get(/databases/$(database)/documents/sharedProjectAccess/$(id + '_' + request.auth.uid)).data.permission == 'editor')
      );
      allow create: if isSignedIn();
    }
    match /designFiles/{id} {
      // 공유 링크를 위해 읽기는 모두 허용, 쓰기는 소유자 또는 편집 권한이 있는 사람만
      allow read: if true;
      allow write: if isSignedIn() && (
        // 소유자인 경우
        request.auth.uid == (request.resource.data.userId != null ? request.resource.data.userId : resource.data.userId) ||
        // 또는 해당 프로젝트에 대한 editor 권한이 있는 경우
        (exists(/databases/$(database)/documents/sharedProjectAccess/$((request.resource.data.projectId != null ? request.resource.data.projectId : resource.data.projectId) + '_' + request.auth.uid)) &&
         get(/databases/$(database)/documents/sharedProjectAccess/$((request.resource.data.projectId != null ? request.resource.data.projectId : resource.data.projectId) + '_' + request.auth.uid)).data.permission == 'editor')
      );
    }

    // 공유 링크
    match /shareLinks/{linkId} {
      allow create: if isSignedIn();
      allow read: if true; // 누구나 토큰으로 조회 가능
      allow update: if isSignedIn();
      allow delete: if isSignedIn() && resource.data.createdBy == request.auth.uid;
    }

    // 공유 프로젝트 접근 권한
    match /sharedProjectAccess/{accessId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // 알림
    match /notifications/{notificationId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if isSignedIn() && resource.data.userId == request.auth.uid;
    }

    // 변경 이력
    match /projectHistory/{historyId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
    }

    // 공유 링크 접근 로그
    match /shareLinkAccessLog/{logId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn();
    }

    // 활동 로그
    match /activityLogs/{logId} {
      allow create: if isSignedIn();
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;
    }
  }
}